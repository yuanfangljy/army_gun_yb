<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type="text/css">
        body, html, #allmap {
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            font-family: "微软雅黑";
        }
     </style>
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">
    <title>Dashboard Template for Bootstrap</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/ie10-viewport-bug-workaround.css" rel="stylesheet">
    <link href="css/dashboard.css" rel="stylesheet">
    <link href="css/index.css" rel="stylesheet" type="text/css"/>
    <script src="js/ie-emulation-modes-warning.js"></script>
    <script type="text/javascript"
            src="http://api.map.baidu.com/api?v=2.0&ak=txyCbKTm1TbFwqyT90iB1t9YLiUY9ZG6"></script>
    <script type="text/javascript" src="layui/laydate/laydate.js"></script>
</head>

<body>

<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid" style="background-color:#022581">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <img src="img/logo.png" width="36" height="36" style=" float:left; margin-top:6px; margin-right:6px">
            <a class="navbar-brand" href="#">枪械定位追踪</a>
        </div>
        <div id="navba	r" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li><a href="#">设置</a></li>
                <li><a href="#">admin</a></li>
            </ul>

        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-xs-3 col-md-1 sidebar" style=" padding-top:0px; padding-bottom:0px; background-color:#004892;">
            <ul class="nav nav-sidebar" id="wanav">
                <li><a href="map.html" style=" border-bottom:1px solid #053e78; line-height:38px;"><img src="img/guangli.png" style="padding-right:20px;">枪支管理</a></li>
                <li><a href="storage.html" style=" border-bottom:1px solid #053e78; line-height:38px;"><img src="img/ruku.png" style="padding-right:20px;">枪支入库</a></li>
                <li><a href="delivery.html" style=" border-bottom:1px solid #053e78; line-height:38px;"><img src="img/chuku.png" style="padding-right:20px;">枪支出库</a></li>
                <li><a href="index.html" style=" border-bottom:1px solid #053e78; line-height:38px;"><img src="img/diaoku.png" style="padding-right:20px;">枪支列表</a></li>
              <li class="activb"><a href="trajectory.html" style=" border-bottom:1px solid #053e78; line-height:38px;"><img src="img/guiji.png" style="padding-right:20px;">枪支轨迹</a></li>
                <li><a href="llibrary.html" style=" border-bottom:1px solid #053e78; line-height:38px;"><img src="img/kushi.png" style="padding-right:20px;">库室管理</a></li>
                <li><a href="warning.html" style=" border-bottom:1px solid #053e78; line-height:38px;"><img src="img/jingao.png" style="padding-right:20px;" id="waNumber">警告信息</a> <span></span></li>
            </ul>
        </div>
    </div>
</div>
<div style=" margin-top: 8px; padding-bottom: 8px; border-bottom: 1px solid #d7d7d7; margin-bottom: 15px ; margin-left:-28%">
    <form class="form-inline" method="post">
        <div class="form-group ">
            <label for="exampleInputName2" style="font-size:14px">枪号</label>
            <input type="text" class="form-control" id="gunTag" name="gunTag" placeholder="选择枪支">
        </div>
        <div class="col-md-4"></div>
        <div class="form-group">
            <label for="" style="font-size:14px; margin-left: 180px">开始时间</label>
            <input type="text" class="form-control" id="startTime" name="startTime" placeholder="开始时间">
        </div>
        <div class="form-group">
            ~
            <input type="text" class="form-control" id="endTime" name="endTime" placeholder="结束时间">
            <label for="" style="font-size:14px">结束时间</label>
        </div>
    </form>

</div>
<dr/>

<!--<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main" style="margin-left:13%; width:87%;">
          <div class="ruku" style=" float:left; margin-top:20px; margin-bottom:20px; position:relative; z-index:9999">
                  <h4 class="sub-header" style="float:left; margin-right:5px;">枪号</h4>
                <select>
    <option value="8651234226">8651234226</option>
    <option value="8651234451">8651234451</option>
    <option value="8125234226">8125234226</option>
    <option value="8651782126">8651782126</option>
    <option value="8612124520">8612124520</option>
    <option value="8120455475">8120455475</option>
    <option value="8876312464">8876312464</option>
    <option value="8782132120">8782132120</option>
    <option value="7898215212">7898215212</option>
    <option value="7861521016">7861521016</option>
    <option value="7844213121">7844213121</option>
                </select>
          </div>
          <div class="time" style=" float:left; margin-top:20px; margin-left:100px">
              <h4 style="float:left; margin-right:10px;">开始时间</h4>
            <input type="date" value="2018-07-19" style="width:150px; height:40px; border:1px solid #CCC; float:left; padding-left:10px"/>
          </div>
          <div style="float:left; padding-top:28px; margin-left:16px">一</div>
          <div class="time" style=" float:left; margin-top:20px; margin-left:16px">
              <h4 style="float:left; margin-right:10px;">结束时间</h4>
            <input type="date" value="2018-07-24" style="width:150px; height:40px; border:1px solid #CCC; float:left; padding-left:10px"/>
          </div>
</div>-->

<div id="allmap" style="margin-left:13%; width:87%;"></div>

<script type="text/javascript" src="js/amq_jquery_adapter.js"></script>
<script type="text/javascript" src="js/amq.js"></script>
<script src="layui/layui.all.js" type="text/javascript"></script>
<script src="js/holder.min.js"></script>
<script src="js/jquery-1.11.1.min.js"></script>
<script src="js/ie10-viewport-bug-workaround.js"></script>
<script type="text/javascript" src="js/ditu/MarkerClusterer.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/library/TextIconOverlay/1.2/src/TextIconOverlay_min.js"></script>
<script type="text/javascript" src="js/mq/stomp.min.js"></script>
<script type="text/javascript" src="js/mq/sockjs.min.js"></script>
<script type="text/javascript" src="js/mq/customer.js"></script>
<script type="text/javascript" src="js/warning/warningNumber.js"></script>
<script type="text/javascript">


 /*   $(function () {
        Trajectory("","","");
    })*/
    //执行一个laydate实例

    laydate.render({
        elem: '#startTime' //指定元素
    });
    laydate.render({
        elem: '#endTime' //指定元素
    });
 //回车查询事件
 $(document).keyup(function (event) {
     if (event.keyCode == 13) {
         Trajectory($("#gunTag").val(),$("#startTime").val(),$("#endTime").val());
     }
 });
</script>
</body>
</html>
<script type="text/javascript">
    // 百度地图API功能//加载地图
    var map = new BMap.Map("allmap");
    var point = new BMap.Point(114.034656, 22.616798);
    map.centerAndZoom(point, 5);

    //1、设置地图的样式
    //map.setMapStyle({style:'midnight'});
    //2、设置地图默认的鼠标指针样式
    map.setDefaultCursor("url('bird.cur')");
    //3、启用滚轮放大缩小，默认禁用
    map.enableScrollWheelZoom();
    //4、启用地图惯性拖拽，默认禁用
    map.enableContinuousZoom();
    //5、进行拖拽
    map.enableScrollWheelZoom(true);
    map.disableDragging();     //禁止拖拽

    setTimeout(function () {
        map.enableDragging();   //两秒后开启拖拽
        map.enableInertialDragging();   //两秒后开启惯性拖拽
    }, 2000);
    //设置地图
    map.addControl(new BMap.MapTypeControl({
        mapTypes: [
            BMAP_NORMAL_MAP,
            BMAP_SATELLITE_MAP//卫星地图
        ]
    }));

    //6、 添加带有定位的导航控件
    var navigationControl = new BMap.NavigationControl({
        // 靠左上角位置
        anchor: BMAP_ANCHOR_TOP_LEFT,
        // LARGE类型
        type: BMAP_NAVIGATION_CONTROL_LARGE,
        // 启用显示定位
        enableGeolocation: true
    });
    map.addControl(navigationControl);
    // 添加定位控件
    var geolocationControl = new BMap.GeolocationControl();
    geolocationControl.addEventListener("locationSuccess", function (e) {
        // 定位成功事件
        var address = '';
        address += e.addressComponent.province;
        address += e.addressComponent.city;
        address += e.addressComponent.district;
        address += e.addressComponent.street;
        address += e.addressComponent.streetNumber;
        alert("当前定位地址为：" + address);
    });
    geolocationControl.addEventListener("locationError", function (e) {
        // 定位失败事件
        layer.alert(e.message);
    });
    map.addControl(geolocationControl);
    //7、============================   轨迹   =======================================
    //定义集合用来存放沿线的坐标值
    var chartData = [];
    var walking=null;
    var startpoint=null;
    var endpoint=null;
    function Trajectory(deviceNo,startTime,endTime) {
    //通过setSearchCompleteCallback回调事件可以把步行间的坐标信息获取
    //walking.setSearchCompleteCallback(function (rs) {
      /*  var pts = walking.getResults().getPlan(0).getRoute(0).getPath();
        for (var i = 0; i < pts.length; i++) {
            chartData.push(new BMap.Point(pts[i].lat, pts[i].lng));
        }*/

        //---------------------       查询轨迹记录      -----------------------
            $.ajax({
                url:"../deviceLocation/queryTheTrajectory",
                type:"POST",
                data:{"deviceNo":deviceNo,"startTime":startTime,"endTime":endTime},
                asynec:true,
                success:function (result) {
                    alert(result.extend.firstLocation.latitude+"-"+ result.extend.firstLocation.longitude
                          +"--"+result.extend.lastLocation.latitude+"--"+result.extend.lastLocation.longitude);
                    walking = new BMap.WalkingRoute(map, { renderOptions: { map: map, autoViewport: true} });
                    startpoint = new BMap.Point(result.extend.firstLocation.longitude, result.extend.firstLocation.latitude);
                    endpoint = new BMap.Point(result.extend.lastLocation.longitude, result.extend.lastLocation.latitude);
//                     startpoint = new BMap.Point(118.112917, 24.435153);
//                     endpoint = new BMap.Point(118.1086487, 24.439108);
                    walking.search(startpoint, endpoint);

                    $.each(result.extend.deviceLocations,function (item, value) {
                        chartData.push(new BMap.Point(value.latitude,value.longitude));
                    })
                }
            })
   // });
    }

    //用来存放途经点的坐标
    var viaRouteData = [];
    viaRouteData.push(endpoint);

    $(function () {
        $("#btn_show").click(function () {
            //这边故意让它晚一秒运行，因为上面获取坐标信息是比较慢又是异步
            setTimeout(ShowRoute, 1000);
        });
    });

    function ShowRoute() {
        var firstPoint;
        var endPoint;
        var newChartData = [];
        //对坐标点重新定义
        $.each(chartData, function (item, value) {
            alert(value.latitude+"----"+value.longitude);
            newChartData.push(new BMap.Point(value.latitude, value.longitude));
        });
        //为了获得起点及终点的坐标值,方便对它进行文字处理
        firstPoint = newChartData[0];
        endPoint = newChartData[newChartData.length - 1];
        //加载地图
        //var maps = new BMap.Map("r-result");
       // map.centerAndZoom(new BMap.Point(118.10000, 24.46667), 15);
        //把步行线路的坐标集合转化成折线
        var polyline = new BMap.Polyline(newChartData, { strokeColor: "red", strokeWeight: 6, strokeOpacity: 0.5 });
        map.addOverlay(polyline);

        //对起点、终点、途经点做一个简单的处理，泡泡跟文字提示
        var m1 = new BMap.Marker(firstPoint);
        var m2 = new BMap.Marker(endPoint);
        map.addOverlay(m1);
        map.addOverlay(m2);
        var lab1 = new BMap.Label("起点", { position: firstPoint });
        var lab2 = new BMap.Label("终点", { position: endPoint });
        map.addOverlay(lab1);
        map.addOverlay(lab2);

        $.each(viaRouteData, function (item, value) {
            var m = new BMap.Marker(value);
            map.addOverlay(m);
            var lab = new BMap.Label("途经点", { position: value });
            map.addOverlay(lab);
        });
    }




</script>